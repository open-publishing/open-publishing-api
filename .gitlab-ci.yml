image: python:3.7

stages:
  - check
  - package
  - publish

.test-python: &test-python
  before_script:
  - pip install -r requirements.txt
  - pip install .
  script:
  - pytest tests/test_init.py

.publish-base: &publish-base
  before_script:
    - pip install --upgrade pip
    - pip install twine
    - echo "Releasing to $TWINE_REPOSITORY_URL"
  script:
    - twine upload dist/*.whl

test-python3.5:
  image: python:3.5
  stage: check
  <<: *test-python

test-python3.6:
  image: python:3.6
  stage: check
  <<: *test-python

test-python3.7:
  image: python:3.7
  stage: check
  <<: *test-python

test-python3.9:
  image: python:3.9
  stage: check
  <<: *test-python

package:
  stage: package
  variables:
    RELEASE_VERSION: "$CI_JOB_ID"
  before_script:
    - pip install --upgrade pip
    - pip install wheel
  script:
    - python setup.py bdist_wheel --universal
  artifacts:
    paths:
    - dist/*

publish:
  stage: publish
  dependencies:
    - package
  only:
    - master
  <<: *publish-base
